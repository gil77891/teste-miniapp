import json
from telegram import Update
from telegram.ext import Updater, CommandHandler, MessageHandler, Filters, CallbackContext
import logging

# Configura o logging
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

TOKEN = "SEU_TOKEN_AQUI"  # Substitua pelo token do seu bot

def start(update: Update, context: CallbackContext) -> None:
    update.message.reply_text('Olá! Abra o miniapp pelo menu do bot para gerenciar sua lista de tarefas.')

def handle_message(update: Update, context: CallbackContext) -> None:
    # Verifica se a mensagem contém web_app_data
    if hasattr(update.message, 'web_app_data') and update.message.web_app_data:
        try:
            data = json.loads(update.message.web_app_data.data)
            logger.info(f"Dados recebidos: {data}")  # Debug
            user_id = data.get('userId', 'Desconhecido')
            itens = data.get('itens', [])

            if itens:
                mensagem = f"Sua lista de tarefas:\n\n" + "\n".join([f"• {item}" for item in itens])
                update.message.reply_text(mensagem)
            else:
                update.message.reply_text("Sua lista está vazia!")
        except Exception as e:
            logger.error(f"Erro: {e}")
            update.message.reply_text("Erro ao processar os dados.")

def main() -> None:
    updater = Updater(TOKEN, use_context=True)
    dispatcher = updater.dispatcher

    dispatcher.add_handler(CommandHandler("start", start))
    # Captura TODAS as mensagens e verifica se contém web_app_data
    dispatcher.add_handler(MessageHandler(Filters.all, handle_message))

    updater.start_polling()
    logger.info("Bot rodando com polling...")
    updater.idle()

if __name__ == '__main__':
    main()
