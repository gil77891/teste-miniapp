<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mini App de Pedidos</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            /* Usa as cores de fundo do tema do usuário no Telegram */
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        h2 {
            color: var(--tg-theme-text-color);
        }
        label {
            display: block;
            margin-top: 10px;
        }
        input, select {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            box-sizing: border-box;
            border: 1px solid var(--tg-theme-hint-color);
            background-color: var(--tg-theme-secondary-bg-color);
            color: var(--tg-theme-text-color);
        }
        /* O Main Button (Botão Principal) do Telegram é geralmente preferido */
        #enviar-html {
            margin-top: 20px;
            padding: 10px 15px;
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none;
            cursor: pointer;
            width: 100%;
            display: none; /* Escondemos este, vamos usar o Main Button do Telegram */
        }
    </style>
</head>
<body>

    <h2>Monte seu Pedido Rápido</h2>

    <form id="pedido-form">
        <label for="item">Selecione o Item:</label>
        <select id="item" required>
            <option value="pizza">Pizza Clássica</option>
            <option value="hamburguer">Mega Burger</option>
            <option value="salada">Salada Fresca</option>
        </select>

        <label for="quantidade">Quantidade:</label>
        <input type="number" id="quantidade" value="1" min="1" required>

        <label for="observacao">Observação (opcional):</label>
        <input type="text" id="observacao" placeholder="Ex: Sem cebola">

        <button type="button" id="enviar-html">Enviar Pedido</button>
    </form>

    <p id="feedback"></p>

    <script>
        // O objeto principal da API Web App do Telegram
        // No seu index.html, dentro da tag <script>
const tg = window.Telegram.WebApp;

// 1. Verificação de Acesso: O objeto tg existe?
if (typeof tg === 'undefined') {
    alert("ERRO FATAL: Objeto Telegram.WebApp não encontrado. Verifique a tag <script> da biblioteca.");
} else {
    // 2. Confirmação de Prontidão
    tg.ready();
    tg.showAlert("API do Telegram carregada com sucesso!");
    // (A Web App só deve abrir se a API carregar. Se isso falhar, o problema é na URL base ou no HTTPS)
}

        // ----------------------------------------------------
        // 1. Configurar o Botão Principal (Melhor Prática)
        // ----------------------------------------------------

        // Define o texto do Botão Principal do Telegram (aquele grande e fixo na parte inferior)
        tg.MainButton.setText('CONCLUIR PEDIDO');
        
        // Exibe o Botão Principal
        tg.MainButton.show();

        // Adiciona um listener (ouvinte) para o clique no Botão Principal
        tg.MainButton.onClick(function() {
            enviarDadosParaBot();
        });

        // ----------------------------------------------------
        // 2. Função de Envio de Dados
        // ----------------------------------------------------
        function enviarDadosParaBot() {
            // Pega os valores dos campos
            const item = document.getElementById('item').value;
            const quantidade = document.getElementById('quantidade').value;
            const observacao = document.getElementById('observacao').value;

            // Cria um objeto JavaScript com os dados
            const dadosDoPedido = {
                item: item,
                quantidade: parseInt(quantidade),
                obs: observacao,
                usuario_id: tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : 'desconhecido'
                // O initDataUnsafe é útil para pegar informações do usuário e validar dados no back-end
            };

            // Converte o objeto para uma string JSON (é o formato mais comum)
            const dadosJSON = JSON.stringify(dadosDoPedido);

            // Confirma na tela e mostra que o processo de envio começou
            tg.MainButton.setText('Enviando...');
            tg.MainButton.showProgress(true); // Mostra o spinner de progresso

            // *** A CHAMADA CRÍTICA: Envia os dados e fecha a Web App ***
            // O bot irá receber esta string de dados como uma mensagem do tipo 'web_app_data'
            try {
    tg.sendData(dadosJSON); 
} catch (error) {
    // Se não fechar, o erro está aqui
    console.error("ERRO na chamada:", error); 
    // Mostra o erro diretamente para o usuário na tela do Telegram
    tg.showAlert('Erro Crítico no Envio! Detalhes: ' + error.message);
    
    // Opcional: Para debugging, envie os logs para o seu back-end (via fetch/ajax)
    // fetch('https://seu-servidor.com/log_erro', { method: 'POST', body: error.message });
}
            
            // Nota: Após sendData(), a Web App é fechada automaticamente pelo Telegram.
            // Se você quiser fazer algo antes de fechar, precisará de uma lógica mais complexa de confirmação.
            // Para este exemplo simples, basta chamar tg.sendData(dadosJSON).
        }

        // ----------------------------------------------------
        // Opcional: Adiciona um feedback visual na Main Button 
        // ----------------------------------------------------
        tg.onEvent('viewportChanged', function() {
            // Se a viewport mudar (ex: teclado abre), podemos ajustar o layout
            console.log("Viewport Alterada");
        });
        
    </script>
</body>
</html>
